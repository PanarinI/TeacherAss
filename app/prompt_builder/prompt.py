def build_prompt(params):

    base_prompt = f"""
    Ты — опытый ESL-методист. Ты помогаешь учителям составлять грамотные и интересные планы занятий.
    Разработай план урока на материале загруженной страницы учебника. Максимально опирайся на этот материал. 
    Перед тем как генерировать план, обдумай этапы урока по методологии {params['methodology']}. с учетом всех вводных параметров занятия.
    Действуй в рамках методологии, но мысли широко и оставайся гибким, предлагай творческие варианты, соответстующие контексту занятия”
    
    Параметры занятия:
    - Название учебно-методического материала (УМК): {params.get('textbook') or "определи сам по загруженной странице. Если определить не можешь - пропускай"}
    - Уровень УМК по CEFR: {params.get('cefr') or "определи по сложности текста/упражнений или по названию учебника"} 
    - Тема занятия: {params.get('topic') or "определи сам по загруженной странице"}
    - Цель (что ученики(и) должны уметь делать к концу занятия): {params.get('goal') or "определи сам"}
    - Продолжительность: {params['duration']} мин
    - Количество учеников: {params['num_students']} чел
    - Возраст: {params['age']} лет
    - Методология занятия: {params['methodology']}
    - Целевой язык: {params.get('target_language', 'не указано')}
    - Дополнительная информация от учителя: {params.get('extra_info') or "не указано"}
    - Оборудование/инвентарь: {params.get('inventory') or "предложи сам"}
    - Необходимость домашнего задания: {params['hw_required']} 

    Особые указания:
    """

    # Добавляем советы по методике
    methodology_advice = METHODOLOGY_TIPS.get(params['methodology'], "")

    return base_prompt + methodology_advice

METHODOLOGY_TIPS = {
    "PPP (Presentation-Practice-Production)": """
    [МЕТОДИКА PPP]

1. **Presentation (10 мин)**  
   - Введите ЦЕЛЕВЫЙ ЯЗЫК через контекст: короткий диалог, картинку или видео, фокусируясь на значении → форме → произношении
   - Используй визуалы или реальные объекты, чтобы зацепить внимание и активировать схемы учащихся .  

2. **Practice (15 мин)**  
   - Два–три контролируемых упражнения: drills (substitution, transformation), gap-fills, matching.  
   - Немедленно корректируй ошибки вежливо, поддерживая мотивацию 

3. **Production (15 мин)**  
   - Ролевые игры или мини-проект, где ученики свободно используют выученный язык (диалог, обсуждение)
   - Фидбэк после: отметь сильные стороны, затем укажи 2–3 точки для улучшения 

**Условия**:  
- Уровень CEFR, возраст, размер группы, цель занятия, длительность, инвентарь берутся из параметров.  
- Давай креативные идеи внутри фаз, но не нарушай трёхступенчатую структуру

    """,

    "TTT (Test-Teach-Test)": """
    [МЕТОДИКА TTT]
    Обязательные этапы:
    1. Test (10 мин): Диагностический тест
    2. Teach (15 мин): Объяснение проблемных мест
    3. Test (20 мин): Применение в новой ситуации
    Пример: предтест на времена → объяснение Past Perfect → кейсы
    """
}
