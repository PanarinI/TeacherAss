def build_prompt(params):
    # с обработкой пустых значений
    def clean_value(value, default):
        if value is None:
            return default
        if isinstance(value, str) and value.strip() == '':
            return default
        return value

    # Создаем базовый промпт как список строк
    prompt_base = [
        f"""
Ты — опытный ESL-методист. Ты помогаешь учителям составлять грамотные и интересные планы занятий.
Разработай план урока на материале загруженной страницы учебника. Максимально опирайся на этот материал. 
Перед тем как генерировать план, обдумай этапы урока по методологии {params['methodology']} с учетом всех вводных параметров занятия.
Будь гибким: адаптируй идеи под реальный контекст занятия, проявляй педагогическое чутьё, не копируй механически структуру. Главная цель — сделать урок живым и полезным!
На всех этапах урока используй материал страницы как основной источник. Указывай номера упражнений в плане.
Используй в плане условные визуальные схемы при необходимости - например, если нужно что-то нарисовать на доске или какую-то таблицу вынести в тетрадь - приведи общий (для понимания сути) набросок в плане.

Параметры занятия:
- УМК: {clean_value(params.get('textbook'), "попробуй определи визуально через логотипы, заголовки, структуру")}
- Уровень УМК по CEFR: {clean_value(params.get('cefr'), "определи по сложности текста/упражнений или по названию учебника")}
- Тема: {clean_value(params.get('topic'), "выяви через ключевые слова/изображения на странице")}
- Цель: {clean_value(params.get('goal'), "сформулируй сам 'К концу урока ученики смогут...'")}
- Возраст: {params['age']} лет (учти: {_get_age_group_comment(params['age'])})
- Продолжительность: {params['duration']} мин
- Количество учеников: {params['num_students']} чел
- Методология занятия: {params['methodology']}
- Соответствие класса (ученика) уровню учебника: {params['level_match']} ({_get_level_match_comment(params['level_match'])})
- Target language: {params.get('target_language') or 'определи самостоятельно по загруженной странице'}
- Оборудование/инвентарь: {params.get('inventory') or "стандартный класс + проектор"}

"""
    ]

    # Добавляем дополнительную информацию ТОЛЬКО если она есть
    if params.get('extra_info'):
        prompt_base.append(f"- Дополнительная информация от учителя: {params['extra_info']}\n")
    if params.get('hw_required'):
        prompt_base.append("- Разработай домашнее задание, логично вытекающее из урока\n")

    # Объединяем все части в одну строку
    base_prompt = "".join(prompt_base)

    # Добавляем советы по методике
    methodology_advice = METHODOLOGY_TIPS.get(params['methodology'], "")

    return base_prompt + methodology_advice


def is_empty_or_whitespace(text):
    """Проверяет, является ли текст пустым или содержит только пробельные символы"""
    return text is None or (isinstance(text, str) and text.strip() == '')

def _get_level_match_comment(level):
    comments = {
        'ниже': "материал проще уровня учеников - добавь усложнённые элементы",
        'на уровне': "материал соответствует уровню учеников",
        'выше': "материал сложнее уровня учеников - предусмотри дополнительные объяснения",
        'mixed': "в группе разные уровни - подготовь дифференцированные задания"
    }
    return comments.get(level, "учти соответствие уровня материала и учеников")

def _get_age_group_comment(age):
    try:
        # Преобразуем в строку на случай, если возраст пришёл как число
        age_str = str(age).strip()

        # Удаляем все нецифровые символы, кроме разделителей (пробел, дефис, запятая)
        cleaned = ''.join(c if c.isdigit() or c in ' -,' else ' ' for c in age_str)

        # Разбиваем по возможным разделителям
        for separator in ['-', ' ', ',']:
            if separator in cleaned:
                age_parts = cleaned.split(separator)
                # Берём первый попавшийся числовой элемент
                for part in age_parts:
                    if part.strip().isdigit():
                        age_int = int(part.strip())
                        break
                break
        else:
            # Если не нашли разделителей - пробуем преобразовать целиком
            age_int = int(cleaned) if cleaned.isdigit() else 0

        # Определяем возрастную группу
        if 6 <= age_int <= 12:
            return "дети: фокус на играх, движении, визуалах, коротких активностях"
        elif 13 <= age_int <= 17:
            return "подростки: актуальные темы (напр. соцсети, игры), групповые проекты, элемент соревнования"
        elif age_int > 17:
            return "взрослые: кейсы из реальной жизни, профессиональные контексты, дискуссии"
        else:
            return "дошкольники: игровое обучение, максимальная наглядность, частая смена деятельности"

    except (ValueError, AttributeError, TypeError):
        return "учти возрастные особенности группы"



METHODOLOGY_TIPS = {
    "PPP (Presentation-Practice-Production)": """
    [МЕТОДИКА PPP]
    
Быстрый чек‑лист перед каждым этапом:

Кто мои ученики? (возраст, уровень CEFR)
Какие части страницы взять за основу урока? (тексты, задания, изображения)
Какая цель урока? (что ученики должны уметь к концу)
Какие упражнения подойдут? (контролируемые/полуконтролируемые/свободные)
Как поддержать слабых учеников? (подсказки, шаблоны, парная работа)

Перед каждым этапом прогоняй чек‑лист, ориентируйся на страницу, параметры урока и свое учительское чутье.

Этап 1: Presentation (20–25% времени)

1) Contextualisation (5–7 мин)
— Придумай живую ситуацию (вопрос, загадку, картинку, мини-историю), связанную с темой страницы.
— Ситуация должна логично вести к нужным языковым элементам.
— Через эту ситуацию естественно выведи target language (лексика, грамматика, выражения).

Контекст не должен быть искусственным: старайся строить ситуацию так, чтобы все target language звучали там естественно и логично. 
Если надо, немного адаптируй формулировки LT для лучшего встраивания.

2) Target Language Discovery
— Помоги ученикам самим «заметить» и «вывести» target language через вопросы (eliciting).
— Затем закрепи его по методу COW:
• Concept: объяснение смысла через примеры и вопросы.
• Oral: устная практика (с акцентом на важные для произношения моменты).
• Written: письменная фиксация (укажи, где будет письменная фиксация - доска/слайды/раздатки etc).

Параметры объема TL:
• A1–A2 (6–12 лет): 3–5 единиц
• A2–B1 (13–17 лет): 5–7 единиц
• B2+: 7–10 единиц


Справка:
    Виды target language:
    Лексика (vocabulary)	Тематические слова и выражения: еда, путешествия, эмоции etc.
    Грамматика (grammar)	Времена, модальные глаголы, условные предложения, артикли etc.
    Функциональный язык (functional language)	Фразы для общения: просьбы, советы, приглашения, извинения etc.
    Фразовые глаголы (phrasal verbs)	Turn up, break down, look after etc.
    Идиомы (idioms)	"Break the ice", "Hit the books" etc.
    Произношение (pronunciation features)	Интонация вопросов, соединение слов (linking sounds), ударение etc.
    Орфография (spelling patterns)	Правила написания: окончания -ing, суффиксы и префиксы etc.
    Синтаксис (syntax)	Порядок слов в вопросах, порядок прилагательных etc.
    Функции дискурса (discourse markers)	Well, actually, you know, I mean... etc.
    Социальные формы речи (register)	Формальный/неформальный стиль общения etc.


Этап 2: Practice (30–40% времени занятия)
Цель этапа: помочь ученикам отработать target language под контролем учителя, чтобы укрепить понимание формы и значения.
Построй этап на базе target language, выбранного на предыдущей фазе.
Используй материал страницы учебника как основу для упражнений (переформатируй задания при необходимости, но сохраняй их смысл и структуру).

Организуй 2–3 контролируемых или полуконтролируемых упражнения.

Если у тебя есть пространство для маневра, начни с упражнений с высокой степенью контроля (чтобы ученики не допускали ошибок).
Постепенно ослабляй контроль, подводя к этапу Production.

Подбирая тип упражнений, учитывая возраст, уровень CEFR, продолжительность урока и количество учеников (пары, мини-группы и т.д.).
Продумай, как предоставить минимальный фидбэк (например, общее исправление ошибок после каждого упражнения).

Справка:
    Неполный список возможных типов упражнений для этапа Practice:
    Controlled drills -	Substitution, transformation, repetition drills.
    Gap-fills	- Вставка пропущенных слов, структур или фраз.
    Matching -	Соотнесение вопросов и ответов, слов и определений.
    Sentence completion -	Завершение предложений целевыми структурами.
    Reordering	Перестановка - элементов для создания правильных предложений.
    Controlled dialogues -	Диалоги с частично заданной структурой.
    Information gap activities - (контролируемые)	Обмен недостающей информацией по чётким правилам.


Этап 3: Production (25–35% времени занятия)
Цель этапа: Дать ученикам возможность свободно и творчески использовать target language в реальной коммуникации.
Построй задание на свободное использование target language.
Используй материал страницы как отправную точку для ситуации, но адаптируй или дополни её, чтобы задание требовало активного создания речи учениками.

Справка:
Возможные типы заданий (можешь использовать и другие варианты по своему усмотрению):

    Role-play | Разыгрывание реальных ситуаций.
    Discussion / Debate | Обсуждение темы урока.
    Mini-project | Создание плаката, презентации, мини-видео.
    Interview | Ученики задают друг другу вопросы.
    Storytelling | Придумывание и рассказывание историй.
    Problem-solving task | Решение задач и кейсов.
    Peer teaching | Объяснение новой лексики друг другу.
    Игры на использование языка | "Find someone who...", викторины и т.д.

Подбирай активность с учётом возраста, уровня и характера группы (например, подростки предпочитают соревновательные задания, взрослые — практические кейсы).

** Корректировки длительности этапов для разных уровней**:
Начинающие (A1-A2):
• Увеличить Practice до 45-50% (больше повторений и структурированных упражнений).
• Сократить Production до 20% (менее сложные задания).

Продвинутые (B2-C1):
• Сократить Presentation до 15% (быстрый ввод материала).
• Увеличить Production до 35-40% (больше дискуссий/кейсов).

    """,

    "TTT (Test-Teach-Test)": """
    [МЕТОДИКА TTT]
    Обязательные этапы:
    1. Test (10 мин): Диагностический тест
    2. Teach (15 мин): Объяснение проблемных мест
    3. Test (20 мин): Применение в новой ситуации
    Пример: предтест на времена → объяснение Past Perfect → кейсы
    """
}




# Этап 1 :Presentation (20–25% времени)
#    — Выбери главный target language (лексика или структура) по материалу страницы.
#    - Придумай общий контекст для всех target language (д
#    Начни урок с некоего интересного объекта, вопроса, иллюстрации, короткого видео, загадки или чего угодно еще, чтобы заинтриговать учеников и задать контекст.
#    — Введи target language по методике: понимание (concept), звуковая форма (oral), письменная форма (written).
#    — Определите количество новых языковых единиц в зависимости от уровня CEFR и возраста учащихся, чтобы обеспечить оптимальное усвоение материала.
#    — Предусмотри, где эти единицы будут представлены письменно (доска, раздатки, заметки).
#    — Дополни план идеями для активации внимания: короткий диалог, обсуждение картинки, мини-видео.


EXTRA_CASES = f"""
    Особые указания:
     Если учебник и возраст явно конфликтуют (напр., медицинский английский для детей 6 лет):
   - Предупреди: "Материал требует адаптации. Предлагаю упрощённый вариант: [идея]"
   - Сохрани 2-3 ключевых элемента страницы, но измени контекст
   Пример: 
   Текст про хирургию → "Лечим плюшевых зверей: bandage, medicine, hurt"
   
    1. Всегда сохраняй структуру выбранной методики, но меняй:
       - Тип активностей (игры ↔ кейсы)
       - Длительность этапов (дети: чаще сменяй задания)
       - Степень автономии (подростки: больше групповой работы)

    2. Если учебник явно не подходит по возрасту:
       - Шаг 1: Выдели ключевые элементы страницы (текст/упражнения/картинки)
       - Шаг 2: Переупакуй их в подходящий формат:
         Пример: 
         Учебник для взрослых → урок для детей 10 лет:
         • Текст о бизнесе → "Создай магазин мечты"
         • Сложные термины → "Придумай смешные названия для товаров"
         • Графики → "Нарисуй идеальный график каникул"

    3. Дифференциация внутри группы:
       - Для mixed ages: предложи 2 варианта одного задания
       Пример: 
       "Basic: Используй слова из рамки. Advanced: Добавь 3 прилагательных"
"""


